# TabletOrderApp Handoff Document

> **Date:** 2026-01-23  
> **Session:** RestoZone API Alignment + Play Store Prep Assessment  
> **Status:** Code changes complete, testing pending

---

## Session Summary

### What Was Done Today

Updated the tablet app to align with the new RestoZone Tablet API specification. The backend team refactored the dispatch system from hardcoded configuration to a database-driven delivery providers system.

#### Files Modified

| File | Changes |
|------|---------|
| `src/types/index.ts` | Added 3 new TypeScript interfaces for dispatch API |
| `src/api/client.ts` | Updated dispatch methods with new headers and response types |
| `src/components/orders/OrderDetailPanel.tsx` | Expanded status support and backup email handling |

#### Specific Changes

**1. New/Updated Types (`src/types/index.ts`)**
```typescript
// OrderStatus - Added missing statuses
export type OrderStatus =
  | 'pending' | 'confirmed' | 'preparing' | 'ready'
  | 'out_for_delivery' | 'delivered'  // NEW
  | 'completed' | 'cancelled';

// Dispatch Types (Multi-Provider Support)
export interface DispatchProvider {
  code: string;           // 'restozone', 'tookan', etc.
  name: string;           // 'RestoZone', 'Tookan', etc.
  external_id: string;    // Restaurant's ID in provider's system
}

export interface DispatchAvailabilityResponse {
  dispatch_available: boolean;
  provider: DispatchProvider | null;
}

export interface DispatchDriverResponse {
  success: boolean;
  order_id: number;
  provider: string;           // Provider code used
  used_backup_email: boolean;
  message: string;
}

export interface DispatchDriverRequest {
  prepTime?: string;        // HH:MM format
  driverEarning?: number;
  distanceKm?: number;
  postalCode?: string;
}
```

**2. API Client Updates (`src/api/client.ts`)**
- `checkDispatchAvailable()` now:
  - Returns new `DispatchAvailabilityResponse` type with `provider` object
  - Uses Bearer auth only (removed X-Device-Id/X-Device-Key headers per new docs)
- `dispatchDriver()` now:
  - Accepts optional `overrides` parameter
  - Returns `DispatchDriverResponse` type with `provider` field
  - Uses Bearer auth only (simplified)

**3. OrderDetailPanel Updates (`src/components/orders/OrderDetailPanel.tsx`)**
- Changed state to use new response format: `{ dispatch_available, provider }`
- Expanded dispatch check from `ready` status only to `confirmed`, `preparing`, `ready`
- Button visibility now uses `dispatchInfo?.dispatch_available && dispatchInfo?.provider`
- Button text now shows provider name: "Request RestoZone Driver" (dynamic)
- Added distinct alert for backup email fallback (`used_backup_email: true`)

---

## Testing Required (Monday)

### Dispatch Feature Testing

Test with these RestoZone-enabled restaurants:

| Restaurant | V3 ID | RestoZone ID | Delivery Enabled |
|------------|-------|--------------|------------------|
| Centertown Donair & Pizza | 131 | 255 | Yes |
| Champa Thai Cuisine | 87 | 203 | Yes |
| Oh My Grill | 807 | 1051 | Yes |
| Sushiyana | 847 | 1094 | Yes |

**Test Cases:**
- [ ] Dispatch button appears for `confirmed` status delivery orders
- [ ] Dispatch button appears for `preparing` status delivery orders
- [ ] Dispatch button appears for `ready` status delivery orders
- [ ] Dispatch button does NOT appear for pickup orders
- [ ] Dispatch button does NOT appear for non-RestoZone restaurants
- [ ] Successful dispatch shows "Driver Requested" badge
- [ ] Network logs show `X-Device-Id` and `X-Device-Key` headers
- [ ] Backup email scenario shows "(Backup)" in alert title

---

## Play Store Deployment - What's Needed

### Config Files Status

Files were recovered from `GitHub 2/TabletOrderApp` folder (cloud sync issue had scattered files):

| Item | Status | Notes |
|------|--------|-------|
| `package.json` | RESTORED | Expo 54, React Native 0.81.5 |
| `app.json` | RESTORED | Package: `ca.menu.orders`, Version 1.1.0 |
| `eas.json` | RESTORED | EAS Build profiles configured |
| `App.tsx` | RESTORED | Main app entry point |
| `index.js` | RESTORED | Expo root component registration |
| `tsconfig.json` | RESTORED | TypeScript config with path aliases |
| `metro.config.js` | RESTORED | Metro bundler config |
| `.gitignore` | RESTORED | Standard Expo gitignore |
| Android folder | MISSING | Run `npx expo prebuild` to generate |
| Privacy Policy URL | EXISTS | `docs/PRIVACY_POLICY.md` - needs hosting |

### Pre-requisites for Play Store

1. **Project Configuration Files** - DONE
   - `package.json` - restored
   - `app.json` - restored (package: `ca.menu.orders`, version: 1.1.0)
   - `eas.json` - restored (EAS project ID: `a8b29fb9-0480-49fb-b993-b008bfb974bf`)

2. **EAS Account Setup**
   - Expo account with EAS enabled
   - Link project: `eas init`
   - Configure build profiles (development, preview, production)

3. **Google Play Console Setup**
   - Create app listing in Play Console
   - Upload signing key or use Play App Signing
   - Complete store listing (screenshots, description, etc.)
   - Privacy Policy URL (host the existing `docs/PRIVACY_POLICY.md`)
   - App content rating questionnaire
   - Data safety form

4. **Build Commands**
   ```bash
   # Install EAS CLI
   npm install -g eas-cli
   
   # Login to Expo
   eas login
   
   # Initialize EAS in project
   eas init
   
   # Build for Android (internal testing)
   eas build --platform android --profile preview
   
   # Build for Play Store submission
   eas build --platform android --profile production
   
   # Submit to Play Store
   eas submit --platform android
   ```

### Current App Configuration

**app.json highlights:**
- App Name: `Menu.ca Orders`
- Package: `ca.menu.orders`
- Version: `1.1.0`
- EAS Project ID: `a8b29fb9-0480-49fb-b993-b008bfb974bf`
- Owner: `brianworklocal`
- Orientation: `landscape`
- Bluetooth permissions included (for thermal printer)

**eas.json profiles:**
- `development` - APK with dev client
- `preview` - APK for internal testing
- `production` - App Bundle for Play Store

---

## Known Issues / Technical Debt

From previous audit (`AI AGENTS READ ME/TabletOrderApp-Audit.md`):

| Issue | Priority | Notes |
|-------|----------|-------|
| Hardcoded test creds in LoginScreen | High | Remove or gate with `__DEV__` |
| Old Supabase service key | Critical | Revoke in Supabase dashboard |
| No QR scanner implementation | Medium | Button shows placeholder alert |
| Sound notification missing | Low | No `assets/notification.mp3` |
| No ESC/POS printer library | Medium | Print service has no bridge |
| Hardcoded BASE_URL | Medium | Consider env-based config |

---

## File Structure Reference

```
TabletOrderApp/
├── App.tsx                          # Main app entry (RESTORED)
├── index.js                         # Expo root registration (RESTORED)
├── package.json                     # Dependencies & scripts (RESTORED)
├── app.json                         # Expo config (RESTORED)
├── eas.json                         # EAS Build config (RESTORED)
├── tsconfig.json                    # TypeScript config (RESTORED)
├── metro.config.js                  # Metro bundler (RESTORED)
├── .gitignore                       # Git ignore rules (RESTORED)
├── AI AGENTS READ ME/
│   └── TabletOrderApp-Audit.md      # Previous audit
├── assets/
│   ├── adaptive-icon.png
│   ├── icon.png
│   ├── logo.png
│   └── splash-icon.png
├── docs/
│   ├── PRIVACY_POLICY.md            # Needs hosting for Play Store
│   └── HANDOFF_2026-01-23.md        # This document
├── src/
│   ├── api/
│   │   ├── client.ts                # REST API client (UPDATED TODAY)
│   │   └── supabaseClient.ts        # DEPRECATED
│   ├── components/
│   │   └── orders/
│   │       └── OrderDetailPanel.tsx # Order detail view (UPDATED TODAY)
│   ├── screens/
│   │   ├── LoginScreen.tsx          # Device login
│   │   ├── OrdersListScreen.tsx     # Main orders view
│   │   └── SettingsScreen.tsx       # App settings
│   ├── services/
│   │   ├── printService.ts          # Printing (needs ESC/POS)
│   │   └── soundService.ts          # Notifications
│   ├── store/
│   │   └── useStore.ts              # Zustand state management
│   └── types/
│       └── index.ts                 # TypeScript types (UPDATED TODAY)
└── node_modules/                    # Dependencies installed
```

---

## API Reference

### Backend Endpoints Used

| Method | Endpoint | Purpose |
|--------|----------|---------|
| POST | `/api/tablet/auth/login` | Device authentication |
| POST | `/api/tablet/auth/refresh` | Token refresh |
| GET | `/api/tablet/orders` | Fetch orders list |
| PATCH | `/api/tablet/orders/{id}/status` | Update order status |
| POST | `/api/tablet/heartbeat` | Device heartbeat |
| GET | `/api/tablet/orders/{id}/dispatch-driver` | Check dispatch availability |
| POST | `/api/tablet/orders/{id}/dispatch-driver` | Request driver |

### Base URL
```
https://orders.menu.ca
```

---

## Quick Start for Next Agent

```bash
# Navigate to project
cd /Users/brianlapp/Documents/GitHub/TabletOrderApp

# If package.json exists, install deps
npm install

# Start Expo dev server
npx expo start

# For Android build (after adding config files)
npx expo prebuild
cd android && ./gradlew assembleDebug
```

---

## Related Documentation

- Backend API: [RESTOZONE_TABLET_API_HANDOFF.md](https://github.com/SantiagoWL117/Migration-Strategy/blob/main/Menu.ca%20V3/Handoffs/RESTOZONE_TABLET_API_HANDOFF.md)
- Delivery Providers: [DELIVERY_PROVIDERS_HANDOFF.md](https://github.com/SantiagoWL117/Migration-Strategy/blob/main/Menu.ca%20V3/Handoffs/DELIVERY_PROVIDERS_HANDOFF.md)

---

**Document Created:** 2026-01-23 by AI Agent
