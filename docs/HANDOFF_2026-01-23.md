# TabletOrderApp Handoff Document

> **Date:** 2026-01-23 (Updated 2026-01-26)  
> **Session:** RestoZone API Alignment + Play Store Deployment  
> **Status:** ✅ v1.2.0 DEPLOYED TO PLAY STORE

---

## Session Summary

### Deployment Success (2026-01-26)

**v1.2.0 is LIVE on Google Play Store!**

| Item | Details |
|------|---------|
| Version | 1.2.0 (versionCode 2) |
| Package | `ca.menu.orders` |
| Build Type | Local Gradle build (not EAS) |
| Signing | Production keystore from EAS credentials |
| Build Time | ~25 seconds (incremental) |

**Files for distribution:**
- Play Store AAB: `~/Desktop/MenuCaOrders-v1.2.0-signed.aab`
- Sideload APK: `~/Desktop/MenuCaOrders-v1.2.0.apk`

**Next release improvements configured:**
- R8 minification enabled (smaller APK)
- Resource shrinking enabled
- Will generate `mapping.txt` for crash debugging

### What Was Done (Jan 23-26)

Updated the tablet app to align with the new RestoZone Tablet API specification. The backend team refactored the dispatch system from hardcoded configuration to a database-driven delivery providers system.

#### Files Modified

| File | Changes |
|------|---------|
| `src/types/index.ts` | Added 3 new TypeScript interfaces for dispatch API |
| `src/api/client.ts` | Updated dispatch methods with new headers and response types |
| `src/components/orders/OrderDetailPanel.tsx` | Expanded status support and backup email handling |

#### Specific Changes

**1. New/Updated Types (`src/types/index.ts`)**
```typescript
// OrderStatus - Added missing statuses
export type OrderStatus =
  | 'pending' | 'confirmed' | 'preparing' | 'ready'
  | 'out_for_delivery' | 'delivered'  // NEW
  | 'completed' | 'cancelled';

// Dispatch Types (Multi-Provider Support)
export interface DispatchProvider {
  code: string;           // 'restozone', 'tookan', etc.
  name: string;           // 'RestoZone', 'Tookan', etc.
  external_id: string;    // Restaurant's ID in provider's system
}

export interface DispatchAvailabilityResponse {
  dispatch_available: boolean;
  provider: DispatchProvider | null;
}

export interface DispatchDriverResponse {
  success: boolean;
  order_id: number;
  provider: string;           // Provider code used
  used_backup_email: boolean;
  message: string;
}

export interface DispatchDriverRequest {
  prepTime?: string;        // HH:MM format
  driverEarning?: number;
  distanceKm?: number;
  postalCode?: string;
}
```

**2. API Client Updates (`src/api/client.ts`)**
- `checkDispatchAvailable()` now:
  - Returns new `DispatchAvailabilityResponse` type with `provider` object
  - Uses Bearer auth only (removed X-Device-Id/X-Device-Key headers per new docs)
- `dispatchDriver()` now:
  - Accepts optional `overrides` parameter
  - Returns `DispatchDriverResponse` type with `provider` field
  - Uses Bearer auth only (simplified)

**3. OrderDetailPanel Updates (`src/components/orders/OrderDetailPanel.tsx`)**
- Changed state to use new response format: `{ dispatch_available, provider }`
- Expanded dispatch check from `ready` status only to `confirmed`, `preparing`, `ready`
- Button visibility now uses `dispatchInfo?.dispatch_available && dispatchInfo?.provider`
- Button text now shows provider name: "Request RestoZone Driver" (dynamic)
- Added distinct alert for backup email fallback (`used_backup_email: true`)

---

## Testing Required (Monday)

### Dispatch Feature Testing

Test with these RestoZone-enabled restaurants:

| Restaurant | V3 ID | RestoZone ID | Delivery Enabled |
|------------|-------|--------------|------------------|
| Centertown Donair & Pizza | 131 | 255 | Yes |
| Champa Thai Cuisine | 87 | 203 | Yes |
| Oh My Grill | 807 | 1051 | Yes |
| Sushiyana | 847 | 1094 | Yes |

**Test Cases:**
- [ ] Dispatch button appears for `confirmed` status delivery orders
- [ ] Dispatch button appears for `preparing` status delivery orders
- [ ] Dispatch button appears for `ready` status delivery orders
- [ ] Dispatch button does NOT appear for pickup orders
- [ ] Dispatch button does NOT appear for non-RestoZone restaurants
- [ ] Successful dispatch shows "Driver Requested" badge
- [ ] Network logs show `X-Device-Id` and `X-Device-Key` headers
- [ ] Backup email scenario shows "(Backup)" in alert title

---

## Play Store Deployment - COMPLETED ✅

### Build Configuration

**Production Keystore (from EAS):**
- Location: `android/app/release.keystore`
- Key Alias: `259b2f59bf12013d2d63c3bef66dbe3d`
- SHA1: `C8:EC:BD:FB:00:8D:9C:C8:33:3D:AC:7A:4F:C8:45:B8:F2:35:04:F2`

**IMPORTANT:** Keystore passwords are in `android/app/build.gradle` signing config. 
The keystore file is excluded from git via `.gitignore`.

### Quick Deploy Commands

```bash
# 1. Update version in android/app/build.gradle
#    versionCode 3 (increment each release)
#    versionName "1.2.1"

# 2. Build signed AAB
cd android
export ANDROID_HOME=/opt/homebrew/share/android-commandlinetools
./gradlew bundleRelease

# 3. Copy to Desktop
cp app/build/outputs/bundle/release/app-release.aab ~/Desktop/MenuCaOrders-v1.2.1.aab

# 4. Upload mapping.txt for crash debugging (R8 enabled)
cp app/build/outputs/mapping/release/mapping.txt ~/Desktop/mapping-v1.2.1.txt

# 5. Go to Play Console → Release → Create new release → Upload both files
```

### Current App Configuration

**app.json highlights:**
- App Name: `Menu.ca Orders`
- Package: `ca.menu.orders`
- Version: `1.2.0`
- EAS Project ID: `a8b29fb9-0480-49fb-b993-b008bfb974bf`
- Owner: `brianworklocal`
- Orientation: `landscape`
- Bluetooth permissions included (for thermal printer)

### Build Optimizations Enabled

| Feature | Status | Benefit |
|---------|--------|---------|
| R8 Minification | ✅ Enabled | Smaller APK, code obfuscation |
| Resource Shrinking | ✅ Enabled | Removes unused resources |
| Deobfuscation File | ✅ Generated | Readable crash reports |

---

## Known Issues / Technical Debt

From previous audit (`AI AGENTS READ ME/TabletOrderApp-Audit.md`):

| Issue | Priority | Notes |
|-------|----------|-------|
| Hardcoded test creds in LoginScreen | High | Remove or gate with `__DEV__` |
| Old Supabase service key | Critical | Revoke in Supabase dashboard |
| No QR scanner implementation | Medium | Button shows placeholder alert |
| Sound notification missing | Low | No `assets/notification.mp3` |
| No ESC/POS printer library | Medium | Print service has no bridge |
| Hardcoded BASE_URL | Medium | Consider env-based config |

---

## File Structure Reference

```
TabletOrderApp/
├── App.tsx                          # Main app entry (RESTORED)
├── index.js                         # Expo root registration (RESTORED)
├── package.json                     # Dependencies & scripts (RESTORED)
├── app.json                         # Expo config (RESTORED)
├── eas.json                         # EAS Build config (RESTORED)
├── tsconfig.json                    # TypeScript config (RESTORED)
├── metro.config.js                  # Metro bundler (RESTORED)
├── .gitignore                       # Git ignore rules (RESTORED)
├── AI AGENTS READ ME/
│   └── TabletOrderApp-Audit.md      # Previous audit
├── assets/
│   ├── adaptive-icon.png
│   ├── icon.png
│   ├── logo.png
│   └── splash-icon.png
├── docs/
│   ├── PRIVACY_POLICY.md            # Needs hosting for Play Store
│   └── HANDOFF_2026-01-23.md        # This document
├── src/
│   ├── api/
│   │   ├── client.ts                # REST API client (UPDATED TODAY)
│   │   └── supabaseClient.ts        # DEPRECATED
│   ├── components/
│   │   └── orders/
│   │       └── OrderDetailPanel.tsx # Order detail view (UPDATED TODAY)
│   ├── screens/
│   │   ├── LoginScreen.tsx          # Device login
│   │   ├── OrdersListScreen.tsx     # Main orders view
│   │   └── SettingsScreen.tsx       # App settings
│   ├── services/
│   │   ├── printService.ts          # Printing (needs ESC/POS)
│   │   └── soundService.ts          # Notifications
│   ├── store/
│   │   └── useStore.ts              # Zustand state management
│   └── types/
│       └── index.ts                 # TypeScript types (UPDATED TODAY)
└── node_modules/                    # Dependencies installed
```

---

## API Reference

### Backend Endpoints Used

| Method | Endpoint | Purpose |
|--------|----------|---------|
| POST | `/api/tablet/auth/login` | Device authentication |
| POST | `/api/tablet/auth/refresh` | Token refresh |
| GET | `/api/tablet/orders` | Fetch orders list |
| PATCH | `/api/tablet/orders/{id}/status` | Update order status |
| POST | `/api/tablet/heartbeat` | Device heartbeat |
| GET | `/api/tablet/orders/{id}/dispatch-driver` | Check dispatch availability |
| POST | `/api/tablet/orders/{id}/dispatch-driver` | Request driver |

### Base URL
```
https://orders.menu.ca
```

---

## Quick Start for Next Agent

```bash
# Navigate to project
cd /Users/brianlapp/Documents/GitHub/TabletOrderApp

# Install dependencies
npm install

# Start Expo dev server (for tablet testing via USB)
npx expo start
# Then: adb reverse tcp:8081 tcp:8081

# Build release APK (for sideloading)
cd android
export ANDROID_HOME=/opt/homebrew/share/android-commandlinetools
./gradlew assembleRelease
# Output: app/build/outputs/apk/release/app-release.apk

# Build AAB for Play Store
./gradlew bundleRelease
# Output: app/build/outputs/bundle/release/app-release.aab
```

### Cursor Skills Available

- `android-local-build` - Build APKs locally (~8 min vs 4+ hour EAS queue)
- `play-store-deploy` - Deploy to Google Play Store with correct signing

---

## Related Documentation

- Backend API: [RESTOZONE_TABLET_API_HANDOFF.md](https://github.com/SantiagoWL117/Migration-Strategy/blob/main/Menu.ca%20V3/Handoffs/RESTOZONE_TABLET_API_HANDOFF.md)
- Delivery Providers: [DELIVERY_PROVIDERS_HANDOFF.md](https://github.com/SantiagoWL117/Migration-Strategy/blob/main/Menu.ca%20V3/Handoffs/DELIVERY_PROVIDERS_HANDOFF.md)

---

**Document Created:** 2026-01-23 by AI Agent  
**Last Updated:** 2026-01-26 - v1.2.0 deployed to Play Store
